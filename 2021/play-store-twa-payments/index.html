<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>
      How to Accept Payments in Your Play Store TWA | Micah Engle-Eshleman
    </title>
    <link rel="shortcut icon" href="/assets/images/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/style.css?v=1" />
    

    
    <script defer data-domain="micahjon.com" src="/assets/js/plsible.js"></script>
  </head>

  <body>
    <nav class="top-nav">
	
		<a href="/"> <span class="arrow">‚Üê</span> Home </a>
	

	
		<a href="/about">About Me </a>
	
	<!-- <a class="cta" href="/feed.xml">Subscribe</a> -->
</nav> 
    

    <main class="centered-column post-container">
      
<article class="post">
  <header class="post__header">
    <h1 class="post__title">How to Accept Payments in Your Play Store TWA</h1>
    <p class="post__date">July 19, 2021</p>  
  </header>
  <section class="post__body"><p>Distributing your PWA as a TWA in the Google Play Store is relatively painless, but transitioning for a single payment provider (e.g. Stripe) to supporting Play Store billing in your TWA can be tricky. Here are a few significant differences:</p>
<ol>
<li>
<p><strong>Price localization:</strong> In Stripe, you choose what currencies you accept and display only those currencies to your users. In the Play Store, USD prices are automatically converted to the user's preferred currency and you need to be able to display arbitrary currencies in your UI.</p>
</li>
<li>
<p><strong>New browser APIs:</strong> Instead of Stripe elements or checkout, you'll be using the Digital Goods API and the Payment Request API to show a native payment prompt to your users and track purchases.</p>
</li>
<li>
<p><strong>Keeping track of users:</strong> The Play Store handles purchases by Google Play accounts and does not expose the email of the paying user to you. This results in some tricky situations we'll get into later.</p>
</li>
</ol>
<h2>High Level Overview</h2>
<p>At a high level, here's how the Play Store payment flow works on a TWA:</p>
<p><strong>On each page load:</strong></p>
<ul>
<li>Detect TWA session</li>
<li>Ask Digital Goods API what the prices are and display them in the UI</li>
<li>Ask Digital Goods API whether the current Google Play user is subscribed (optional)</li>
</ul>
<p><strong>When a user is ready to pay:</strong></p>
<ul>
<li>Use Payment Request API to show native browser prompt and get token</li>
<li>Send token to your backend API to validate &amp; record payment</li>
<li>Acknowledge purchase using Digital Goods API</li>
</ul>
<h3>Detect TWA session</h3>
<p><a href="/2021/pwa-twa-detection/">Detecting that the user is using your TWA</a> and needs to pay with Play Store billing instead of Stripe is trivial.</p>
<h3>Get Prices from Digital Goods API</h3>
<p>First off, enter your USD prices for one-time purchases or subscriptions in the Google Play console. You can manually specify prices in other currencies, or just let the Play Store do the currency conversions automatically.</p>
<p>The price objects you'll be working with look something like this:</p>
<pre class="language-js"><code class="language-js"><span class="token comment">/**<br> * Play Store prices are used by TWA<br> * @typedef GooglePlayPrice <br> * @property {string} id - Plny Storen-us - e.g. 'es' or 'es-mx' for English<br> * @property {string} currency - e.g. "USD"<br> * @property {string} value - e.g. "2.99"<br> */</span><br><br><span class="token keyword">const</span> priceObjects <span class="token operator">=</span> <span class="token punctuation">{</span><br>  <span class="token literal-property property">monthly</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>    <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">'plus_tier_monthly_2_99'</span><span class="token punctuation">,</span><br>    <span class="token literal-property property">currency</span><span class="token operator">:</span> <span class="token string">'USD'</span><span class="token punctuation">,</span><br>    <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">'2.99'</span><span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token literal-property property">yearly</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>    <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">'plus_tier_yearly_24_99'</span><span class="token punctuation">,</span><br>    <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">'2'</span><span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre>
<p>Notice how above I've hard-coded the default USD currency and value. I wouldn't have to, but it's good to have a fallback in case the Digital Goods API request fails (e.g. user is offline).</p>
<p>Next, we'll update these prices to match the user's preferred currency:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">updatePlayStorePrices</span><span class="token punctuation">(</span><span class="token parameter">monthlyPrice<span class="token punctuation">,</span> yearlyPrice</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// Connect to Digital Goods service</span><br>  <span class="token keyword">const</span> service <span class="token operator">=</span> <span class="token keyword">await</span> window<span class="token punctuation">.</span><span class="token function">getDigitalGoodsService</span><span class="token punctuation">(</span><span class="token string">'https://play.google.com/billing'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// Request latest price data from Play Store</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span><br>    monthlyPriceDetails<span class="token punctuation">,</span> <br>    yearlyPriceDetails<br>  <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> service<span class="token punctuation">.</span><span class="token function">getDetails</span><span class="token punctuation">(</span><span class="token punctuation">[</span>monthlyPrice<span class="token punctuation">.</span>id<span class="token punctuation">,</span> yearlyPrice<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>  <span class="token comment">// Update currency &amp; value to match user's preferred currency</span><br>  Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>monthlyPrice<span class="token punctuation">,</span> <span class="token punctuation">{</span><br>    <span class="token literal-property property">currency</span><span class="token operator">:</span> monthlyPriceDetails<span class="token punctuation">.</span>price<span class="token punctuation">.</span>currency<span class="token punctuation">,</span><br>    <span class="token literal-property property">value</span><span class="token operator">:</span> monthlyPriceDetails<span class="token punctuation">.</span>price<span class="token punctuation">.</span>value<span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>yearlyPrice<span class="token punctuation">,</span> <span class="token punctuation">{</span><br>    <span class="token literal-property property">currency</span><span class="token operator">:</span> yearlyPriceDetails<span class="token punctuation">.</span>price<span class="token punctuation">.</span>currency<span class="token punctuation">,</span><br>    <span class="token literal-property property">value</span><span class="token operator">:</span> yearlyPriceDetails<span class="token punctuation">.</span>price<span class="token punctuation">.</span>value<span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">try</span> <span class="token punctuation">{</span><br>  <span class="token keyword">await</span> <span class="token function">updatePlayStorePrices</span><span class="token punctuation">(</span>priceObjects<span class="token punctuation">.</span>monthly<span class="token punctuation">,</span> priceObjects<span class="token punctuation">.</span>yearly<span class="token punctuation">)</span><br><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// Log a warning in your error reporting software</span><br>  <span class="token function">reportError</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">'Failed to update Play Store prices. Falling back to USD.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<h3>Rendering Arbitrary Currencies in UI</h3>
<p>Given that a price's <code>currency</code> and <code>value</code> will change based on the user's preferred payment method, it's important that your UI is flexible enough to render an arbitrary price string. The <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Intl/NumberFormat"><code>Intl.NumberFormat</code> browser method</a> makes it easy to format any currency in any language:</p>
<pre class="language-js"><code class="language-js"><span class="token comment">/**<br> * Format price for display in UI<br> * @param {GooglePlayPrice} price <br> * @param {string} langId - e.g. 'en' or 'en-us' for English<br> * @return {string}<br> */</span><br><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">formatPrice</span><span class="token punctuation">(</span><span class="token parameter">price<span class="token punctuation">,</span> langId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> currency <span class="token punctuation">}</span> <span class="token operator">=</span> price<span class="token punctuation">;</span><br><br>    <span class="token keyword">const</span> numberFormat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intl<span class="token punctuation">.</span>NumberFormat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>langId<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><br>        <span class="token literal-property property">style</span><span class="token operator">:</span> <span class="token string">'currency'</span><span class="token punctuation">,</span><br>        currency<span class="token punctuation">,</span><br>        <span class="token literal-property property">currencyDisplay</span><span class="token operator">:</span> <span class="token string">'symbol'</span><span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">return</span> numberFormat<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>For the <a href="https://www.befunky.com/pricing/">befunky.com/pricing</a> page, we do some additional formatting to emphasize the major unit (dollars) of the price over the minor unit (cents). Getting this right for all language/currency combinations is nigh impossible, but we are able to do it for some common scenarios.</p>
<p><img src="/assets/images/befunky-prices.png" alt="BeFunky Price UI"></p>
<pre class="language-js"><code class="language-js"><span class="token comment">/**<br> * Template for rendering price<br> * @param {GooglePlayPrice} price <br> * @param {string} langId - e.g. 'en' or 'en-us' for English<br> * @return {string}<br> */</span><br><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">priceTemplate</span><span class="token punctuation">(</span><span class="token parameter">priceObject<span class="token punctuation">,</span> languageId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> formattedPrice <span class="token operator">=</span> <span class="token function">formatPrice</span><span class="token punctuation">(</span>priceObject<span class="token punctuation">,</span> languageId<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <br>  <span class="token comment">// Grab the symbol &amp; suffix from the formatted price</span><br>  <span class="token keyword">const</span> nonNumericParts <span class="token operator">=</span> formattedPrice<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\d</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> prefix <span class="token operator">=</span> nonNumericParts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> suffix <span class="token operator">=</span> nonNumericParts<span class="token punctuation">[</span>nonNumericParts<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// Grab part of price that is numbers</span><br>  <span class="token keyword">let</span> numericPrice <span class="token operator">=</span> formattedPrice<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>prefix<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  numericPrice <span class="token operator">=</span> numericPrice<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> numericPrice<span class="token punctuation">.</span>length <span class="token operator">-</span> suffix<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// If there's decimal values at the end, make them small</span><br>  <span class="token keyword">const</span> pricePartsMatch <span class="token operator">=</span> numericPrice<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^(.+)([.,])(\d\d)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>pricePartsMatch<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> majorAmount<span class="token punctuation">,</span> delimiter<span class="token punctuation">,</span> minorAmount<span class="token punctuation">]</span> <span class="token operator">=</span> pricePartsMatch<span class="token punctuation">;</span><br>      <span class="token keyword">return</span> <span class="token function">template</span><span class="token punctuation">(</span><span class="token punctuation">{</span> prefix<span class="token punctuation">,</span> majorAmount<span class="token punctuation">,</span> minorAmount<span class="token punctuation">,</span> suffix<span class="token punctuation">,</span> delimiter <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token comment">// Decimal value not found, just render the full price string</span><br>  <span class="token keyword">return</span> <span class="token function">template</span><span class="token punctuation">(</span><span class="token punctuation">{</span> prefix<span class="token punctuation">,</span> <span class="token literal-property property">majorAmount</span><span class="token operator">:</span> numericPrice<span class="token punctuation">,</span> suffix <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">/**<br>    * Template for displaying large dollars beside small cents<br>    * @param {string} largeAmount - dollars<br>    * @param {string} [smallAmount] - cents<br>    * @param {string} [prefix] - $<br>    * @param {string} [suffix] - suffix to indicate currency, e.g MXN in "$100 MXN"<br>    * @param {string} [delimiter] - between dollars &amp; cents<br>    * @return {TemplateResult}<br>    */</span><br>  <span class="token keyword">function</span> <span class="token function">template</span><span class="token punctuation">(</span>prefix<span class="token punctuation">,</span> largeAmount<span class="token punctuation">,</span> smallAmount<span class="token punctuation">,</span> suffix<span class="token punctuation">,</span> delimiter <span class="token operator">=</span> <span class="token string">'.'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> html<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"><br>      </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefix <span class="token operator">?</span> html<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;span class="small-text"></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token string">''</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"><br>      &lt;span class="large-amount"></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>largeAmount<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/span><br>      </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>smallAmount <span class="token operator">?</span> html<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;span class="small-amount"></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>delimiter<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>smallAmount<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token string">''</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"><br>      </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>suffix <span class="token operator">?</span> html<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;span class="small-text"></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>suffix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token string">''</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"><br>    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<h3>Handling Already-Subscribed Google Play Users</h3>
<p>When using your own payment processor (e.g. Stripe), your user database is the source of truth concerning what users have active subscriptions.</p>
<p>In contrast, the Play Store manages subscribing and unsubscribing, and just exposes the ID of the subscription to your backend (via a webhook or API request). You don't actually know what the Google Play user's name or email is. You just know what account they were logged-in to in your application when they subscribed.</p>
<ul>
<li>From your perspective, a particular user account (a@a.com) is subscribed and associated with a Play Store subscription ID.</li>
<li>From the Play Store's perspective, all devices with a particular Google Play account (b@b.com) are subscribed to your app.</li>
</ul>
<p>This leads to a disconnect whenever a user is on a device profile with the subscribed Google Play account (b@b.com) but not logged-in to the associated user account on your app. For instance:</p>
<ul>
<li>
<p>They log out of the <code>a@a.com</code> account in the TWA and let a friend use their device. The friend logs into the app as <code>c@c.com</code>, and when they try to upgrade, the Play Store says &quot;you've already subscribed&quot;.</p>
</li>
<li>
<p>Their <code>a@a.com</code> session expires. They're confused why they can no longer access premium features, since they know the have an active Play Store subscription for your app.</p>
</li>
</ul>
<p>In both cases, you'll need to develop a flow that acknowledges that the Google Play user on this device is subscribed, but that they'll need to login to your app with the associated account (e.g. <code>a@a.com</code>) to use premium features.</p>
<p>Here's a basic outline of a solution:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handlePlayStoreUser</span><span class="token punctuation">(</span><span class="token parameter">currentAppUser</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// Current app user is already subscribed, no need to bother them</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>currentAppUser<span class="token punctuation">.</span>isSubscribed<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// Connect to Digital Goods service</span><br>  <span class="token keyword">const</span> service <span class="token operator">=</span> <span class="token keyword">await</span> window<span class="token punctuation">.</span><span class="token function">getDigitalGoodsService</span><span class="token punctuation">(</span><span class="token string">'https://play.google.com/billing'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <br>  <span class="token comment">// Get purchases made by current Google Play account</span><br>  <span class="token keyword">const</span> purchases <span class="token operator">=</span> <span class="token keyword">await</span> service<span class="token punctuation">.</span><span class="token function">listPurchases</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>purchases<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// Get app user associated with these purchases from your backend</span><br>  <span class="token keyword">const</span> subscribedUser <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">requestApi</span><span class="token punctuation">(</span><span class="token string">'get-user-for-play-store-purchases'</span><span class="token punctuation">,</span> purchases<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>subscribedUser <span class="token operator">&amp;&amp;</span> subscribedUser<span class="token punctuation">.</span>email <span class="token operator">!==</span> currentAppUser<span class="token punctuation">.</span>email<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Prompt user to login with the email address of the upgraded account associated </span><br>    <span class="token comment">// with their active Play Store subscription</span><br>    <span class="token function">showDialog</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Welcome back! Please login to this app as </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>subscribedUser<span class="token punctuation">.</span>email<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> to use premium features.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p><em>Alternatively, you could let any account on the device use premium features, but that would probably involve a much deeper refactor of your app's logic.</em></p>
<h2>Handling Payments</h2>
<p>This part is actually pretty straightforward!</p>
<ol>
<li>
<p>Use PaymentRequest API to display a native payment prompt to your user.</p>
</li>
<li>
<p>Send token for the approved payment to your backend.</p>
</li>
<li>
<p>On the backend, validate token using Google Play API and upgrade the associated user account.</p>
</li>
<li>
<p>Acknowledge the payment using the Digital Goods API.</p>
</li>
</ol>
<pre class="language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">processPayment</span><span class="token punctuation">(</span><span class="token parameter">priceId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br><br>  <span class="token comment">// Build payment request</span><br>  <span class="token keyword">const</span> paymentMethod <span class="token operator">=</span> <span class="token punctuation">[</span><br>    <span class="token punctuation">{</span><br>      <span class="token literal-property property">supportedMethods</span><span class="token operator">:</span> <span class="token string">'https://play.google.com/billing'</span><span class="token punctuation">,</span><br>      <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">sku</span><span class="token operator">:</span> priceId <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">]</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// 1. Open native dialog to prompt user to pay</span><br>  <span class="token keyword">let</span> token<span class="token punctuation">;</span><br>  <span class="token keyword">try</span> <span class="token punctuation">{</span><br>    paymentResponse <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">PaymentRequest</span><span class="token punctuation">(</span>paymentMethod<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    token <span class="token operator">=</span> paymentResponse<span class="token punctuation">.</span>details<span class="token punctuation">.</span>token<span class="token punctuation">;</span><br><br>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'was cancelled'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token comment">// User dismissed native dialog</span><br>        <span class="token function">logWarning</span><span class="token punctuation">(</span><span class="token string">'User chose not to subscribe:'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>        <span class="token comment">// Report unexpected error</span><br>        <span class="token function">reportError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token string">'PaymentRequest.show() failed'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">return</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token comment">// 2. Send token to our API to validate subscription &amp; update database</span><br>  <span class="token keyword">let</span> validationResponse<span class="token punctuation">;</span><br>  <span class="token keyword">try</span> <span class="token punctuation">{</span><br>      <span class="token comment">// 3. Validate on backend using Google Play Developer API</span><br>      <span class="token comment">// https://developers.google.com/android-publisher/api-ref/rest/v3/purchases.subscriptions/get</span><br>      validationResponse <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">requestAPI</span><span class="token punctuation">(</span><span class="token string">'validate-play-store-payment'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> priceId<span class="token punctuation">,</span> token <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <br>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>validationResponse<span class="token punctuation">.</span>isValid<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Failed to validate token'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Report unexpected error</span><br>    <span class="token function">reportError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> validationResponse<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Show payment failed UI</span><br>    <span class="token keyword">await</span> paymentResponse<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token string">'fail'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token comment">// 4. Acknowledge purchase with Digital Goods API. Otherwise, user will get refund in 3 days.</span><br>  <span class="token keyword">try</span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> service <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getDigitalGoodsServiceOnce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> service<span class="token punctuation">.</span><span class="token function">acknowledge</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token string">'onetime'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Report unexpected error</span><br>    <span class="token function">reportError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token string">'Failed to acknowledge purchase'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Show payment failed UI</span><br>    <span class="token keyword">await</span> paymentResponse<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token string">'fail'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token comment">// Thank user for purchasing a subscription!</span><br>  <span class="token comment">// ...</span><br><span class="token punctuation">}</span></code></pre>
<p>Feel free to leave a comment if any of this doesn't make sense or could be improved!</p>
<p>I'm in the process of building out this flow for BeFunky, and will update this article as our approach evolves over time.</p>
</section>
  <footer class="post__footer">
    <img class="post__footer-avatar" src="/assets/images/profile-circle-240-tiny.png" />
    <p class="post__footer-author">Micah Engle-Eshleman</p>
    <section class="share">
  <a class="share__button share__button--twitter" href="https://twitter.com/intent/tweet?text=/2021/play-store-twa-payments/ -  by @">
    <svg viewBox="0 0 128 128">
      <path d="M128 28.3c-4.7 2.1-9.775 3.5-15.075 4.125 5.425-3.25 9.575-8.4 11.55-14.525-5.075 3-10.7 5.2-16.675 6.375-4.8-5.1-11.625-8.275-19.175-8.275-14.5 0-26.25 11.75-26.25 26.25 0 2.050 0.225 4.050 0.675 5.975-21.825-1.1-41.175-11.55-54.125-27.45-2.25 3.875-3.55 8.4-3.55 13.2 0 9.1 4.625 17.15 11.675 21.85-4.3-0.125-8.35-1.325-11.9-3.275 0 0.1 0 0.225 0 0.325 0 12.725 9.050 23.35 21.075 25.75-2.2 0.6-4.525 0.925-6.925 0.925-1.7 0-3.325-0.175-4.95-0.475 3.35 10.425 13.050 18.025 24.525 18.25-9 7.050-20.3 11.25-32.625 11.25-2.125 0-4.2-0.125-6.275-0.375 11.65 7.475 25.45 11.8 40.275 11.8 48.3 0 74.725-40.025 74.725-74.725 0-1.15-0.025-2.275-0.075-3.4 5.125-3.675 9.575-8.3 13.1-13.575z"></path>
    </svg>
    Tweet
  </a>
  <a class="share__button share__button--facebook" href="#" onclick="
      window.open(
        'https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent(location.href),
        'facebook-share-dialog',
        'width=626,height=436');
      return false;">
    <svg viewBox="0 0 128 128">
      <path d="M76 24h20v-24h-20c-15.439 0-28 12.561-28 28v12h-16v24h16v64h24v-64h20l4-24h-24v-12c0-2.168 1.832-4 4-4z"></path>
    </svg>
    Facebook
  </a>
</section>
  </footer>
</article>

<div class="comments">
	<h3 class="comments__heading">Comments are welcome!</h3>
	<div id="disqus_thread"></div>
	<script>
	var disqus_config = function () {
		// Page url without query parameters or hashes
		this.page.url = window.location.href.split('?')[0].split('#')[0];
		// Id is just slug of post
		this.page.identifier = '';
	};
	(function() { // DON'T EDIT BELOW THIS LINE
		var d = document, s = d.createElement('script');
		s.src = '//micahjon.disqus.com/embed.js';
		s.setAttribute('data-timestamp', +new Date());
		(d.head || d.body).appendChild(s);
	})();
	</script>
	<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

    </main>

    <footer class="site-footer">
    <p>¬© Copyright <span id="currentYear"></span> Micah Engle-Eshleman</p>
    <script>document.getElementById('currentYear').textContent = new Date().getFullYear()</script>
    
</footer>


    <script async src="/assets/js/main.js?v=1"></script>
    <link href="/assets/css/prism-material-oceanic.css" rel="stylesheet">

  <style>
    
  </style>


  </body>
</html>
