<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>
      Setting up Custom Authorization in Ember-CLI using Google oAuth2 for the Initial Login | Micah Engle-Eshleman
    </title>
    <link rel="shortcut icon" href="/assets/images/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/style.css?v=1" />
    

    
    <script defer data-api="https://ana.adblockpodcast.com/api/event" data-domain="micahjon.com" src="/assets/js/plsible.js"></script>
  </head>

  <body>
    <nav class="top-nav">
	
		<a href="/"> <span class="arrow">←</span> Home </a>
	

	
		<a href="/about">About Me </a>
	
	<a href="https://github.com/micahjon" target="_blank" style="padding: 0.5rem 0.25rem">
		<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" style="vertical-align: middle; margin-top: -4px;">
			<path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
		</svg>
	</a>
	<!-- <a class="cta" href="/feed.xml">Subscribe</a> -->
</nav> 
    

    <main class="centered-column post-container">
      
<article class="post">
  <header class="post__header">
    <h1 class="post__title">Setting up Custom Authorization in Ember-CLI using Google oAuth2 for the Initial Login</h1>
    <p class="post__date">June 15, 2015</p>  
  </header>
  <section class="post__body"><p>I've found it handy in Ember-CLI apps to use Google logins for initial authentication (that way I don't have to store passwords). The question is how to transform a Google login into a session that can be used to query user-specific resources from my own server (not just Google's APIs). Here's a high level view of the process:</p>
<ul>
<li><strong>User</strong> logs in to their Google account, and authorizes Ember <strong>app</strong>. <em>In this process the app receives a Google token.</em></li>
<li><strong>App</strong> sends Google token to the node <strong>server</strong> in response for a new token. <em>The server validates the Google token and then uses it to get user info from Google. It then creates a new custom token containing a user id, which it sends to the app.</em></li>
<li><strong>App</strong> uses it's new custom token in all further requests to the <strong>server</strong>. <em>Right before this token expires, it will be refreshed.</em></li>
</ul>
<p>In this process, <em>token</em> refers to a JSON web token. We'll be using the following open-source projects to build a basic app (for the finished product, <a href="https://github.com/micahjon/basic-auth-demo">see my GitHub repo</a>).</p>
<h3>Ember Client:</h3>
<ol>
<li><a href="http://www.ember-cli.com/">Ember-Cli</a></li>
<li><a href="http://ember-simple-auth.com/">Ember Simple Auth</a> and <a href="https://github.com/jpadilla/ember-cli-simple-auth-token">Ember CLI Simple Auth Token</a> extension</li>
<li><a href="http://vestorly.github.io/torii/">Torii</a> Google Oauth2 Bearer provider</li>
</ol>
<h3>Node Server:</h3>
<ol>
<li><a href="http://expressjs.com/">Express</a> for creating REST API routes</li>
<li><a href="https://github.com/auth0/node-jsonwebtoken">jsonwebtoken</a> and <a href="https://github.com/auth0/express-jwt">express-jwt</a> for encoding and decoding JSON web tokens</li>
<li><a href="https://github.com/request/request">request</a> for talking with Google's APIs</li>
<li><a href="https://github.com/expressjs/body-parser">bodyParser</a> for extracting the body (data) from the app's requests.</li>
</ol>
<h2>Step 1: Setup Ember-CLI app structure</h2>
<p>Create a simple folder structure:</p>
<pre>
basic-auth-demo
    ember-client
    node-server
</pre>
<p>Instead of actually making an &quot;ember-client&quot; folder, just run:</p>
<pre class="language-bash"><code class="language-bash">ember new ember-client</code></pre>
<p>within the <em>basic-auth-demo</em> folder. Then we'll set up the following route structure:</p>
<pre class="language-bash"><code class="language-bash">ember g route s<br>ember g route s/notes</code></pre>
<p>The idea is that any subroute of s (for &quot;secure&quot;) will be protected from public access by a Google login. Ember Simple Auth has some mixins that make this a synch. Initially, I'll set up some really basic templates to keep track of our nested routes.</p>
<pre class="language-handlebars"><code class="language-handlebars"><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>title<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Welcome to Ember.js<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span><br><br><span class="token handlebars language-handlebars"><span class="token delimiter punctuation">{{</span><span class="token block keyword">#if</span> <span class="token variable">session</span><span class="token punctuation">.</span><span class="token variable">isAuthenticated</span><span class="token delimiter punctuation">}}</span></span><br> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token handlebars language-handlebars"><span class="token delimiter punctuation">{{</span> <span class="token variable">action</span> <span class="token string">'invalidateSession'</span> <span class="token delimiter punctuation">}}</span></span></span><span class="token punctuation">></span></span>Logout<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><br><span class="token handlebars language-handlebars"><span class="token delimiter punctuation">{{</span><span class="token variable">else</span><span class="token delimiter punctuation">}}</span></span><br> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token handlebars language-handlebars"><span class="token delimiter punctuation">{{</span> <span class="token variable">action</span> <span class="token string">'sessionRequiresAuthentication'</span> <span class="token delimiter punctuation">}}</span></span></span><span class="token punctuation">></span></span>Login<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><br><span class="token handlebars language-handlebars"><span class="token delimiter punctuation">{{</span><span class="token block keyword">/if</span><span class="token delimiter punctuation">}}</span></span><br><br><span class="token handlebars language-handlebars"><span class="token delimiter punctuation">{{</span><span class="token variable">outlet</span><span class="token delimiter punctuation">}}</span></span><br></code></pre>
<pre class="language-handlebars"><code class="language-handlebars"><br><span class="token comment">&lt;!-- s.hbs template --></span><br><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">></span></span>This is a secure route.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">></span></span><br><br><span class="token handlebars language-handlebars"><span class="token delimiter punctuation">{{</span><span class="token variable">outlet</span><span class="token delimiter punctuation">}}</span></span><br></code></pre>
<pre class="language-handlebars"><code class="language-handlebars"><br><span class="token comment">&lt;!-- s/notes.hbs route --></span><br><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>A list of secure notes...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><br><br><span class="token handlebars language-handlebars"><span class="token delimiter punctuation">{{</span><span class="token variable">outlet</span><span class="token delimiter punctuation">}}</span></span><br></code></pre>
<p>Then if you run <code>ember s</code> and navigate to <em>localhost:4200/s/notes</em> you should see something like this:</p>
<p><img src="/assets/images/welcome-to-emberjs.png" alt="Ember notes route"></p>
<h2>Step 2: Setup node server to return tokens</h2>
<p>In the <em>node-server</em> folder, create a <em>server.js</em> file.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// express framework for routing</span><br><span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><br><br><span class="token comment">// create and validate json web tokens</span><br><span class="token keyword">var</span> createJWT <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'jsonwebtoken'</span><span class="token punctuation">)</span><br><span class="token keyword">var</span> validateJWT <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express-jwt'</span><span class="token punctuation">)</span></code></pre>
<p>Then setup a node project with <code>npm init</code> (it creates a package.json to track dependencies--you can just press Enter at the prompts)</p>
<pre class="language-bash"><code class="language-bash"><span class="token builtin class-name">cd</span> node-server<br><span class="token function">npm</span> init</code></pre>
<p>and install the modules we required in <em>server.js</em>.</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> express --save<br><span class="token function">npm</span> <span class="token function">install</span> jsonwebtoken --save<br><span class="token function">npm</span> <span class="token function">install</span> express-jwt --save</code></pre>
<p>Great, now you can try to run your node server!</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">node</span> server</code></pre>
<p>If nothing happened, that's a good thing. It means there were no errors. Now let's actually set up the node server that listens on port 4500. Add these lines to <em>server.js</em></p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// startup and listen on port 4500</span><br><span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token string">'4500'</span><span class="token punctuation">)</span><br><br><span class="token comment">// setup HTTP headers</span><br>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Origin'</span><span class="token punctuation">,</span> <span class="token string">'http://localhost:4200'</span><span class="token punctuation">)</span><br>  res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><br>    <span class="token string">'Access-Control-Allow-Headers'</span><span class="token punctuation">,</span><br>    <span class="token string">'Origin, X-Requested-With, Content-Type, Accept, Authorization'</span><br>  <span class="token punctuation">)</span><br>  res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Methods'</span><span class="token punctuation">,</span> <span class="token string">'POST, GET, PUT, DELETE, OPTIONS'</span><span class="token punctuation">)</span><br>  res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span><br>  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><br><br><span class="token comment">// respond with "yolo" to a GET request to the root (localhost:4500)</span><br>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'yolo'</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>This time when your run <code>node server</code> it should pause (until you hit Ctrl-C) b/c it's listening to port 4500. Try going to <em>localhost:4500</em> in your browser and you should see &quot;yolo&quot;.</p>
<p><img src="/assets/images/yolo.png" alt="Node serves up &quot;yolo&quot; at root"></p>
<p>We can use this same syntax to respond to Ember when it requests a json web token with a POST request. Add the following to <em>server.js</em> to serve up a token when a POST request is sent to <em>localhost:4500/get-token</em>.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// respond w/ token to POST request to /get-token</span><br>app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/get-token'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> token <span class="token operator">=</span> createJWT<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><br>    <span class="token comment">// payload</span><br>    <span class="token punctuation">{</span> <span class="token literal-property property">currentUserId</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token comment">// secret</span><br>    <span class="token string">'09htfahpkc0qyw4ukrtag0gy20ktarpkcasht'</span><span class="token punctuation">,</span><br>    <span class="token comment">// options</span><br>    <span class="token punctuation">{</span> <span class="token literal-property property">expiresInMinutes</span><span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><br>  <span class="token punctuation">)</span><br>  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">token</span><span class="token operator">:</span> token <span class="token punctuation">}</span><span class="token punctuation">)</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'\tsent token'</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>Now, use a browser extension like <a href="https://chrome.google.com/webstore/detail/postman/fhbjgbiflinjbdggehcddcbncdddomop">Postman for Chrome</a> to send a POST request to <em>localhost:4500/get-token</em>. You'll need to restart the server (ctrl-c, then <code>node server</code> again) first to incorporate the new code or you'll get a &quot;Cannot POST /get-token&quot; error.</p>
<p><img src="/assets/images/get-token-POST.png" alt="Sending POST request to fetch token w/ Postman"></p>
<p><em>Just for fun: to get a good grasp of what the token actually stores, paste it into the <a href="http://jwt.io/">jwt.io</a>.</em></p>
<h2>Step 3: Hook up Ember Simple Auth with node server</h2>
<p>Install <a href="http://ember-simple-auth.com/">Ember Simple Auth</a> and <a href="https://github.com/jpadilla/ember-cli-simple-auth-token">its token-based extension</a>.</p>
<pre class="language-bash"><code class="language-bash"><span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>/ember-client<br>ember <span class="token function">install</span> ember-cli-simple-auth<br>ember <span class="token function">install</span> ember-cli-simple-auth-token</code></pre>
<p><em>Tip: I generally find it best to open up two terminal tabs open so I can have <code>node server</code> running while I work in Ember</em> Then let's create an adapter so Ember knows where it's API server is:</p>
<pre class="language-bash"><code class="language-bash">ember g adapter application</code></pre>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// application.js adapter</span><br><br><span class="token keyword">import</span> <span class="token constant">DS</span> <span class="token keyword">from</span> <span class="token string">'ember-data'</span><br><br><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token constant">DS</span><span class="token punctuation">.</span>RESTAdapter<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  <span class="token literal-property property">host</span><span class="token operator">:</span> <span class="token string">'http://localhost:4500'</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>And setup the authentication addons by adding the following properties to <em>ENV</em> in <em>config/environment.js</em>:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token literal-property property">contentSecurityPolicy</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>  <span class="token string-property property">'connect-src'</span><span class="token operator">:</span> <span class="token string">"'self' http://localhost:4500"</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">,</span><br><br><span class="token string-property property">'simple-auth-token'</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>  <span class="token literal-property property">serverTokenEndpoint</span><span class="token operator">:</span> <span class="token string">'http://localhost:4500/get-token'</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">,</span><br><br><span class="token string-property property">'simple-auth'</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>  <span class="token literal-property property">authorizer</span><span class="token operator">:</span> <span class="token string">'simple-auth-authorizer:token'</span><br><span class="token punctuation">}</span></code></pre>
<p>Great, now we'll setup <em>s</em> as a protected route and handle authentication in the <em>application</em> route.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// s (secure) route</span><br><br><span class="token keyword">import</span> Ember <span class="token keyword">from</span> <span class="token string">'ember'</span><br><span class="token keyword">import</span> AuthenticatedRouteMixin <span class="token keyword">from</span> <span class="token string">'simple-auth/mixins/authenticated-route-mixin'</span><br><br><span class="token keyword">export</span> <span class="token keyword">default</span> Ember<span class="token punctuation">.</span>Route<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>AuthenticatedRouteMixin<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p><em>Note: I had to manually create an application.js file in app/routes</em></p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// application route</span><br><br><span class="token keyword">import</span> Ember <span class="token keyword">from</span> <span class="token string">'ember'</span><br><span class="token keyword">import</span> ApplicationRouteMixin <span class="token keyword">from</span> <span class="token string">'simple-auth/mixins/application-route-mixin'</span><br><br><span class="token keyword">export</span> <span class="token keyword">default</span> Ember<span class="token punctuation">.</span>Route<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>ApplicationRouteMixin<span class="token punctuation">,</span> <span class="token punctuation">{</span><br>  <span class="token literal-property property">actions</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>    <span class="token function-variable function">sessionRequiresAuthentication</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'session'</span><span class="token punctuation">)</span><br>        <span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token string">'simple-auth-authenticator:jwt'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token string">''</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><br>        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><br>          <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'custom token authentication successful!'</span><span class="token punctuation">)</span><br>          <span class="token punctuation">}</span><span class="token punctuation">,</span><br>          <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'custom token authentication failed!'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><br>          <span class="token punctuation">}</span><br>        <span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>Assuming that both <code>ember s</code> and <code>node server</code> are running, you should now be able to log in and out of your Ember application and only access /s/ routes when logged in. At this point there is still no real security. Anonymous users are handed tokens willy-nilly, but it's a good start.</p>
<h2>Step 4: Setting up Google Account logins</h2>
<p>It may be tempting at this point to use a the Google oAuth2 Torii provider bundled into the <a href="https://github.com/simplabs/ember-simple-auth/tree/master/packages/ember-simple-auth-torii">Ember Simple Auth Torii</a> extension, and simply authenticate with Google and right before authenticating w/ our node server. The problem is that upon authentication, Ember Simple Auth lets the user access secure routes. In other words, /s/notes can be transitioned to <em>before</em> the second authentication with our node server happens and an authorizer is actually set up. I imagine there is a workaround to this problem but I found it simpler to just use Torri providers directly w/out the authenticator wrapper.</p>
<pre class="language-bash"><code class="language-bash">ember <span class="token function">install</span> torii</code></pre>
<p>You can setup the Google oAuth2 Bearer provider by adding a <em>torii</em> property to <em>ENV</em> in <em>environment.js</em>.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token literal-property property">torii</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>      <span class="token literal-property property">providers</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>        <span class="token string-property property">'google-oauth2-bearer'</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>          <span class="token literal-property property">apiKey</span><span class="token operator">:</span> <span class="token string">'10514958320583-as0utyahvaekgprntiashtoasht.apps.googleusercontent.com'</span><span class="token punctuation">,</span><br>          <span class="token literal-property property">redirectUri</span><span class="token operator">:</span> <span class="token string">'http://localhost:4200'</span><span class="token punctuation">,</span><br>        <span class="token punctuation">}</span><span class="token punctuation">,</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span></code></pre>
<p>To get an <em>apiKey</em>, go to the <a href="https://console.developers.google.com/project">Google Developer Console</a> and create a new project. Click on <em>Credentials</em> under <em>APIs &amp; auth</em> in the left side nav and select <em>Create new Client ID</em> under <em>OAuth</em>, choosing <em>Web Application</em> in the popup. (You may need to <em>Configure the consent screen</em> first--just enter the <em>Product Name</em> and click <em>Save</em>). Now, in the popup, enter <em>http://localhost:4200</em> in both fields (<em>authorized javascript origins</em> and <em>authorized redirect uri</em>). The first requires an actual domain and the second doesn’t need to redirect to any particular Ember route since Ember will handle this on it’s own. Copy the <em>Client ID</em> string, and paste it into <em>environment.js</em> as (you guessed it) the <em>apiKey</em>. At this point, we just need to set up the Application route to log in with Google first and then send the Google token to the node server for custom authentication. Making a few minor edits to <em>sessionRequiresAuthentication</em>:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token function-variable function">sessionRequiresAuthentication</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">var</span> session <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'session'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'torii'</span><span class="token punctuation">)</span><br>        <span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'google-oauth2-bearer'</span><span class="token punctuation">)</span><br>        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">googleAuth</span><span class="token punctuation">)</span><span class="token punctuation">{</span><br>            <span class="token keyword">var</span> googleToken <span class="token operator">=</span> googleAuth<span class="token punctuation">.</span>authorizationToken<span class="token punctuation">.</span>access_token<span class="token punctuation">;</span><br>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Google authentication successful.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>            session<br>                <span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token string">'simple-auth-authenticator:jwt'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">password</span><span class="token operator">:</span> googleToken<span class="token punctuation">}</span> <span class="token punctuation">)</span><br>                <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><br>                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'custom token authentication successful!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'custom token authentication failed!'</span><span class="token punctuation">,</span> error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span><br>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Google auth failed: '</span><span class="token punctuation">,</span> error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>Notice how I pass <em>googleToken</em> to the node server as a <em>password.</em> Now, we just need to set up the node server to parse this token, fetch the current user from Google, and return an user-identifying token that can be used for authorizing secure resources. If everything is working, when you click on <em>Login</em> you should see a <em>Request for Permission</em> popup from Google.</p>
<p><img src="/assets/images/oauth-modal.png" alt="Google login"></p>
<h2>Step 5: Fetching user info from Google</h2>
<p>In <em>server.js</em>, instead of just returning a token, we must first <a href="https://developers.google.com/identity/protocols/OAuth2UserAgent#validatetoken">validate the Google token</a> against Google's API. In this process, Google will send back a unique user id and an email address. We can also call the Google+ People API to get additional data, such as the displayName and image. All of this information can then be used to create/update/find the current user in our backend database and return a unique token, which contains a valid user id, to Ember. The <code>{password: googleToken}</code> object is passed to the server as JSON in the body of the POST request. To get it, we'll need to install the <a href="https://github.com/expressjs/body-parser">body-parser middleware</a>. We'll also install the <a href="https://github.com/request/request">request</a> library to make a server-side request to Google.</p>
<pre class="language-bash"><code class="language-bash"><span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>/node-server<br><span class="token function">npm</span> <span class="token function">install</span> body-parser --save<br><span class="token function">npm</span> <span class="token function">install</span> request --save</code></pre>
<p>and then at the top of <em>server.js</em>:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// decodes json in the body of a request and stores it as req.body</span><br><span class="token keyword">var</span> bodyParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'body-parser'</span><span class="token punctuation">)</span><br><br><span class="token comment">// simple HTTP request client</span><br><span class="token keyword">var</span> request <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">)</span></code></pre>
<p>The next step is simply expanding <code>app.post('/get-token')</code> to <a href="https://developers.google.com/identity/protocols/OAuth2UserAgent#validatetoken">validate the token</a>.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// secret used to construct json web token</span><br>app<span class="token punctuation">.</span>secret <span class="token operator">=</span> <span class="token string">'09htfahpkc0qyw4ukrtag0gy20ktarpkcasht'</span><br><br><span class="token comment">// send token to user that contains their id</span><br>app<span class="token punctuation">.</span><span class="token function-variable function">sendToken</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res<span class="token punctuation">,</span> userId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> token <span class="token operator">=</span> createJWT<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><br>    <span class="token comment">// payload</span><br>    <span class="token punctuation">{</span> <span class="token literal-property property">userId</span><span class="token operator">:</span> userId <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token comment">// secret</span><br>    app<span class="token punctuation">.</span>secret<span class="token punctuation">,</span><br>    <span class="token comment">// options</span><br>    <span class="token punctuation">{</span> <span class="token literal-property property">expiresInMinutes</span><span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><br>  <span class="token punctuation">)</span><br>  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">token</span><span class="token operator">:</span> token <span class="token punctuation">}</span><span class="token punctuation">)</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'\tsent token'</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// respond w/ token to POST request to /get-token</span><br>app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/get-token'</span><span class="token punctuation">,</span> bodyParser<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// get Google token from Ember: { password: googleToken }</span><br>  <span class="token keyword">var</span> googleToken <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>password<br><br>  <span class="token comment">// send token to Google for validation</span><br>  <span class="token function">request</span><span class="token punctuation">(</span><br>    <span class="token string">'https://www.googleapis.com/oauth2/v1/tokeninfo?access_token='</span> <span class="token operator">+</span><br>      googleToken<span class="token punctuation">,</span><br>    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> response<span class="token punctuation">,</span> body</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>error <span class="token operator">&amp;&amp;</span> response<span class="token punctuation">.</span>statusCode <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'\tGoogle Token Valid'</span><span class="token punctuation">)</span><br>        <span class="token keyword">var</span> userId <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">.</span>user_id<br>        <span class="token keyword">var</span> userEmail <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">.</span>email<br>        app<span class="token punctuation">.</span><span class="token function">sendToken</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><br>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'\tFailed to validate Google Token'</span><span class="token punctuation">)</span><br>        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">)</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>Here, I created a new <code>app.sendToken</code> function for token creation. The created token now contains the Google id, so the node server will always know which Google user it's getting requests from. A more typical setup would be to exchange the Google id and email for whatever the associated user id is in your backend, and then use this id in the token, but I thought I'd keep things as simple as possible.</p>
<h2>Step 6: Refreshing the token</h2>
<p>Our token expires in 10 minutes, so user's will have to log in w/ Google every 10 minutes. That's no good! We're going to create a refresh token endpoint at <em>localhost:4500/refresh-token</em> that will get used 1 minute before the token expires. Just update <em>simple-auth-token</em> in <em>environment.js</em>.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token string-property property">'simple-auth-token'</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>  <span class="token comment">// get token</span><br>  <span class="token literal-property property">serverTokenEndpoint</span><span class="token operator">:</span> <span class="token string">'http://localhost:4500/get-token'</span><span class="token punctuation">,</span><br>  <span class="token comment">// refresh token</span><br>  <span class="token literal-property property">serverTokenRefreshEndpoint</span><span class="token operator">:</span> <span class="token string">'http://localhost:4500/refresh-token'</span><span class="token punctuation">,</span><br>  <span class="token comment">// timeFactor * refreshLeeway = milliseconds before token refresh</span><br>  <span class="token literal-property property">timeFactor</span><span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">,</span><br>  <span class="token literal-property property">refreshLeeway</span><span class="token operator">:</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token comment">// 1 minute</span><br><span class="token punctuation">}</span><span class="token punctuation">,</span></code></pre>
<p>Then we'll create that endpoint in <em>server.js</em>. Here, we'll parse the token, get the <code>userId</code>, and then send back a new token with the same <code>userId</code>.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// Refresh token</span><br>app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/refresh-token'</span><span class="token punctuation">,</span> bodyParser<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// verify token and extract contents (including userId)</span><br>  <span class="token keyword">var</span> oldToken <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>token<br>  createJWT<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>oldToken<span class="token punctuation">,</span> app<span class="token punctuation">.</span>secret<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> decodedToken</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token comment">// send new token</span><br>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'\tRefreshing token for user '</span><span class="token punctuation">,</span> decodedToken<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><br>      app<span class="token punctuation">.</span><span class="token function">sendToken</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> decodedToken<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><br>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>      <span class="token comment">// send error</span><br>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'\tError while trying to refresh token:'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><br>      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>Just for testing, modify <code>{ expiresInMinutes: 10 }</code> in <code>app.sendToken</code> so tokens expire every 2 minutes. This way you should see a token refresh every minute in your <code>node server</code> terminal and in the Network tab of the Chrome console on <em>localhost:4200</em> once you're logged in. [</p>
<p><img src="/assets/images/token-requests.png" alt="/get-token and /refresh-token"></p>
<p>Congrats! If you've gotten this far you're <strong>good to go!</strong> The next step is authorizing resources, which is pretty straightforward. Set up a model in Ember and then handle it's request like so:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// User requests list of notes</span><br>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/notes'</span><span class="token punctuation">,</span> <span class="token function">validateJWT</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">secret</span><span class="token operator">:</span> app<span class="token punctuation">.</span>secret<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br><br>    <span class="token comment">// get userId from token</span><br>    <span class="token keyword">var</span> userId <span class="token operator">=</span> req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>userId<span class="token punctuation">;</span><br><br>    <span class="token comment">// lookup notes for user...</span><br>    <span class="token keyword">var</span> notes <span class="token operator">=</span> <span class="token punctuation">{</span><br>        <span class="token string-property property">'id'</span><span class="token operator">:</span> <span class="token number">1</span><br>        <span class="token string-property property">'content'</span><span class="token operator">:</span> <span class="token string">'A note for user '</span><span class="token operator">+</span> userId<span class="token punctuation">,</span><br>        <span class="token string-property property">'user'</span><span class="token operator">:</span> userId<br>    <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// send notes to Ember</span><br>    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">notes</span><span class="token operator">:</span> notes <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Here, <code>validateJWT</code> (actually the <em>express-jwt</em> library), automatically parses the token and provides <code>req.user</code>. This is handy for quickly getting the userId in each request from Ember to serve up the appropriate resources. In the above example, I return some JSON to Ember w/ <em>notes</em> as the top-level element. This is currently how Ember Data likes to receive data, but is changing with <a href="http://emberjs.com/blog/2015/06/18/ember-data-1-13-released.njk">version 1.13</a> and the introduction of <a href="http://jsonapi.org/format/">JSON API</a>.</p>
<hr>
<p>Hey, this is my first Ember tutorial and I'd appreciate your feedback! Authentication &amp; Authorization can be tricky to get right, and I hope this pattern helps you get a better feel for things. If you run into issues, please consult my git repo <a href="https://github.com/micahjon/basic-auth-demo">github.com/micahjon/basic-auth-demo</a> or leave a comment. Special thanks to <a href="https://github.com/mgenev">Martin Genev</a> whose <a href="http://www.100percentjs.com/authentication-single-page-applications-apis-sane-stack/">post on 100PercentJS</a> got me started.</p>
</section>
  <footer class="post__footer">
    <img class="post__footer-avatar" src="/assets/images/profile-circle-240-tiny.png" />
    <p class="post__footer-author">Micah Engle-Eshleman</p>
    <section class="share">
  <a class="share__button share__button--twitter" href="https://twitter.com/intent/tweet?text=/2015/setting-up-custom-authorization-in-ember-cli-using-google-oauth2-for-the-initial-login/ -  by @">
    <svg viewBox="0 0 128 128">
      <path d="M128 28.3c-4.7 2.1-9.775 3.5-15.075 4.125 5.425-3.25 9.575-8.4 11.55-14.525-5.075 3-10.7 5.2-16.675 6.375-4.8-5.1-11.625-8.275-19.175-8.275-14.5 0-26.25 11.75-26.25 26.25 0 2.050 0.225 4.050 0.675 5.975-21.825-1.1-41.175-11.55-54.125-27.45-2.25 3.875-3.55 8.4-3.55 13.2 0 9.1 4.625 17.15 11.675 21.85-4.3-0.125-8.35-1.325-11.9-3.275 0 0.1 0 0.225 0 0.325 0 12.725 9.050 23.35 21.075 25.75-2.2 0.6-4.525 0.925-6.925 0.925-1.7 0-3.325-0.175-4.95-0.475 3.35 10.425 13.050 18.025 24.525 18.25-9 7.050-20.3 11.25-32.625 11.25-2.125 0-4.2-0.125-6.275-0.375 11.65 7.475 25.45 11.8 40.275 11.8 48.3 0 74.725-40.025 74.725-74.725 0-1.15-0.025-2.275-0.075-3.4 5.125-3.675 9.575-8.3 13.1-13.575z"></path>
    </svg>
    Tweet
  </a>
  <a class="share__button share__button--facebook" href="#" onclick="
      window.open(
        'https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent(location.href),
        'facebook-share-dialog',
        'width=626,height=436');
      return false;">
    <svg viewBox="0 0 128 128">
      <path d="M76 24h20v-24h-20c-15.439 0-28 12.561-28 28v12h-16v24h16v64h24v-64h20l4-24h-24v-12c0-2.168 1.832-4 4-4z"></path>
    </svg>
    Facebook
  </a>
</section>
  </footer>
</article>

<div class="comments">
	<h3 class="comments__heading">Comments are welcome!</h3>
	<div id="disqus_thread"></div>
	<script>
	var disqus_config = function () {
		// Page url without query parameters or hashes
		this.page.url = window.location.href.split('?')[0].split('#')[0];
		// Id is just slug of post
		this.page.identifier = '';
	};
	(function() { // DON'T EDIT BELOW THIS LINE
		var d = document, s = d.createElement('script');
		s.src = '//micahjon.disqus.com/embed.js';
		s.setAttribute('data-timestamp', +new Date());
		(d.head || d.body).appendChild(s);
	})();
	</script>
	<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

    </main>

    <footer class="site-footer">
    <p>© Copyright <span id="currentYear"></span> Micah Engle-Eshleman</p>
    <script>document.getElementById('currentYear').textContent = new Date().getFullYear()</script>
    
</footer>


    <script async src="/assets/js/main.js?v=1"></script>
    <link href="/assets/css/prism-material-oceanic.css" rel="stylesheet">

  <style>
    
  </style>


  </body>
</html>
