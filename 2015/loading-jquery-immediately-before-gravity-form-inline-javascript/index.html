<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>
      Loading jQuery Immediately before Gravity Forms | Micah Engle-Eshleman
    </title>
    <link rel="shortcut icon" href="/assets/images/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/style.css?v=1" />
    

    
    <script defer data-api="https://analytics.adblockpodcast.com/api/event" data-domain="micahjon.com" src="/assets/js/plsible.js"></script>
  </head>

  <body>
    <nav class="top-nav">
	
		<a href="/"> <span class="arrow">←</span> Home </a>
	

	
		<a href="/about">About Me </a>
	
	<!-- <a class="cta" href="/feed.xml">Subscribe</a> -->
</nav> 
    

    <main class="centered-column post-container">
      
<article class="post">
  <header class="post__header">
    <h1 class="post__title">Loading jQuery Immediately before Gravity Forms</h1>
    <p class="post__date">May 18, 2015</p>  
  </header>
  <section class="post__body"><p>Loading jQuery asychronously or in the footer on pages with ajax-enabled Gravity Forms is tricky because the form relies on inlined jQuery-dependent scripts that immediately follow it in the DOM:</p>
<p>![Inline jQuery-dependent Gravity Form scripts](/assets/images/Screen Shot 2016-10-31 at 12.55.36 AM.png)</p>
<p>In this case, the typical <code>gform_init_scripts_footer</code> solution doesn't work, because moving jQuery to the footer would break these inline scripts.</p>
<p>Another solution I've run across uses <code>gform_cdata_open</code> and <code>gform_cdata_close</code> to wrap these inline scripts in a function that's called once jQuery has been loaded. However, this clever technique can generate errors on payment forms (e.g. <code>Uncaught ReferenceError: gf_global is not defined</code>) due to the scripts being run after <em>DOMContentLoaded</em> instead of before as Gravity Form expects.</p>
<p>Ultimately, the most reliable (and performant) solution I've found is to inject a synchronous jQuery <code>&lt;script&gt;</code> <em>immediately</em> before the inline scripts using the <code>gform_cdata_open</code> hook once.</p>
<pre class="language-php"><code class="language-php"><span class="token comment">/**<br> * Deregister jQuery in &lt;head>, so it can be loaded in the footer or before the<br> * first Gravity Form on the page.<br> */</span><br><span class="token keyword">function</span> <span class="token function-definition function">gc_deregister_default_jquery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>	<span class="token function">wp_deregister_script</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'jquery'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><span class="token function">add_action</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'wp_enqueue_scripts'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'gc_deregister_default_jquery'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">/**<br> * Inject synchronous jQuery dependency before the Gravity Form inline scripts<br> */</span><br><span class="token keyword">function</span> <span class="token function-definition function">inject_jquery_above_gravity_form</span><span class="token punctuation">(</span> <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span> <span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>	<span class="token comment">// keep track of jquery so it's not loaded twice!</span><br>	<span class="token keyword">global</span> <span class="token variable">$jquery_already_injected</span><span class="token punctuation">;</span><br><br>	<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$jquery_already_injected</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span><br><br>		<span class="token variable">$jquery_already_injected</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span><br><br>		<span class="token comment">// End inline script</span><br>		<span class="token variable">$content</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"&lt;/script>\n"</span><span class="token punctuation">;</span><br><br>		<span class="token comment">// Inject jQuery</span><br>		<span class="token variable">$content</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"&lt;script src='/path/to/jquery.min.js'>&lt;/script>\n"</span><span class="token punctuation">;</span><br><br>		<span class="token comment">// Start inline script again</span><br>		<span class="token variable">$content</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"&lt;script>"</span><span class="token punctuation">;</span><br>	<span class="token punctuation">}</span><br><br>	<span class="token keyword">return</span> <span class="token variable">$content</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><span class="token function">add_filter</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'gform_cdata_open'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'inject_jquery_above_gravity_form'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">/**<br> * Enqueue jQuery in footer unless it's already been injected above Gravity Form.<br> * In this case, enqueue a fake version to trigger dependent scripts, and then remove this fake version.<br> */</span><br><br><span class="token keyword">function</span> <span class="token function-definition function">enqueue_jquery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>	<span class="token keyword">global</span> <span class="token variable">$jquery_already_injected</span><span class="token punctuation">;</span><br><br>	<span class="token comment">// jQuery has not been loaded</span><br>	<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$jquery_already_injected</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token function">wp_enqueue_script</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'jquery'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token punctuation">}</span><br>	<span class="token comment">// jQuery has already been loaded above a Gravity Form</span><br>	<span class="token keyword">else</span> <span class="token punctuation">{</span><br><br>		<span class="token comment">// Enqueue fake script to trigger dependencies</span><br>		<span class="token function">wp_enqueue_script</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'jquery'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'//fake-jquery-script.js'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">null</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>		<span class="token comment">// Remove this fake script's HTML before it's actually injected into the DOM</span><br>		<span class="token keyword">function</span> <span class="token function-definition function">gc_remove_fake_jquery_script</span><span class="token punctuation">(</span> <span class="token variable">$tag</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span><br>			<span class="token variable">$tag</span> <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$tag</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'fake-jquery-script'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant boolean">false</span> <span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string single-quoted-string">''</span> <span class="token punctuation">:</span> <span class="token variable">$tag</span><span class="token punctuation">;</span><br>			<span class="token keyword">return</span> <span class="token variable">$tag</span><span class="token punctuation">;</span><br>		<span class="token punctuation">}</span><br>		<span class="token function">add_filter</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'script_loader_tag'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'gc_remove_fake_jquery_script'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token punctuation">}</span><br><br><span class="token punctuation">}</span><br><span class="token function">add_action</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'wp_footer'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'enqueue_jquery'</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Your comments and feedback are welcome!</p>
</section>
  <footer class="post__footer">
    <img class="post__footer-avatar" src="/assets/images/profile-circle-240-tiny.png" />
    <p class="post__footer-author">Micah Engle-Eshleman</p>
    <section class="share">
  <a class="share__button share__button--twitter" href="https://twitter.com/intent/tweet?text=/2015/loading-jquery-immediately-before-gravity-form-inline-javascript/ -  by @">
    <svg viewBox="0 0 128 128">
      <path d="M128 28.3c-4.7 2.1-9.775 3.5-15.075 4.125 5.425-3.25 9.575-8.4 11.55-14.525-5.075 3-10.7 5.2-16.675 6.375-4.8-5.1-11.625-8.275-19.175-8.275-14.5 0-26.25 11.75-26.25 26.25 0 2.050 0.225 4.050 0.675 5.975-21.825-1.1-41.175-11.55-54.125-27.45-2.25 3.875-3.55 8.4-3.55 13.2 0 9.1 4.625 17.15 11.675 21.85-4.3-0.125-8.35-1.325-11.9-3.275 0 0.1 0 0.225 0 0.325 0 12.725 9.050 23.35 21.075 25.75-2.2 0.6-4.525 0.925-6.925 0.925-1.7 0-3.325-0.175-4.95-0.475 3.35 10.425 13.050 18.025 24.525 18.25-9 7.050-20.3 11.25-32.625 11.25-2.125 0-4.2-0.125-6.275-0.375 11.65 7.475 25.45 11.8 40.275 11.8 48.3 0 74.725-40.025 74.725-74.725 0-1.15-0.025-2.275-0.075-3.4 5.125-3.675 9.575-8.3 13.1-13.575z"></path>
    </svg>
    Tweet
  </a>
  <a class="share__button share__button--facebook" href="#" onclick="
      window.open(
        'https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent(location.href),
        'facebook-share-dialog',
        'width=626,height=436');
      return false;">
    <svg viewBox="0 0 128 128">
      <path d="M76 24h20v-24h-20c-15.439 0-28 12.561-28 28v12h-16v24h16v64h24v-64h20l4-24h-24v-12c0-2.168 1.832-4 4-4z"></path>
    </svg>
    Facebook
  </a>
</section>
  </footer>
</article>

<div class="comments">
	<h3 class="comments__heading">Comments are welcome!</h3>
	<div id="disqus_thread"></div>
	<script>
	var disqus_config = function () {
		// Page url without query parameters or hashes
		this.page.url = window.location.href.split('?')[0].split('#')[0];
		// Id is just slug of post
		this.page.identifier = '';
	};
	(function() { // DON'T EDIT BELOW THIS LINE
		var d = document, s = d.createElement('script');
		s.src = '//micahjon.disqus.com/embed.js';
		s.setAttribute('data-timestamp', +new Date());
		(d.head || d.body).appendChild(s);
	})();
	</script>
	<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

    </main>

    <footer class="site-footer">
    <p>© Copyright <span id="currentYear"></span> Micah Engle-Eshleman</p>
    <script>document.getElementById('currentYear').textContent = new Date().getFullYear()</script>
    
</footer>


    <script async src="/assets/js/main.js?v=1"></script>
    <link href="/assets/css/prism-material-oceanic.css" rel="stylesheet">

  <style>
    
  </style>


  </body>
</html>
