<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>
      How to Track Audio/Video File Loading Progress with Workbox | Micah Engle-Eshleman
    </title>
    <link rel="shortcut icon" href="/assets/images/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/style.css?v=1" />
    

    
    <script defer data-api="https://ana.adblockpodcast.com/api/event" data-domain="micahjon.com" src="/assets/js/plsible.js"></script>
  </head>

  <body>
    <nav class="top-nav">
	
		<a href="/"> <span class="arrow">‚Üê</span> Home </a>
	

	
		<a href="/about">About Me </a>
	
	<!-- <a class="cta" href="/feed.xml">Subscribe</a> -->
</nav> 
    

    <main class="centered-column post-container">
      
<article class="post">
  <header class="post__header">
    <h1 class="post__title">How to Track Audio/Video File Loading Progress with Workbox</h1>
    <p class="post__date">May 23, 2022</p>  
  </header>
  <section class="post__body"><p>When working on my <a href="https://www.adblockpodcast.com/">Adblock Podcast side project</a>, I had to figure out how to download and cache audio files using a service worker, and show the download progress in the UI. You'll run into the same problem for video and other large files that need to be downloaded for offline viewing.</p>
<p>Workbox is a fantastic library for this, and has <a href="https://developer.chrome.com/docs/workbox/using-plugins/#methods-for-custom-plugins">great documentation</a> on how to write a plugin to hook into particular parts of the fetching &amp; caching lifecycle. I'd also recommend their article on the nuances of <a href="https://developer.chrome.com/docs/workbox/serving-cached-audio-and-video/">serving cached audio &amp; video</a>.</p>
<p>Fortunately, there's an excellent Github repo (<a href="https://github.com/AnthumChris/fetch-progress-indicators">AnthumChris/fetch-progress-indicators</a>) with a service worker example of tracking download progess using a <code>ReadableStream</code>, which we can adapt as a Workbox plugin.</p>
<p>First off, register a <code>CacheFirst</code> route that deals exclusively with the files you'd like to track (in my case, audio files).</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// service-worker.js</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span> registerRoute <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'workbox-routing'</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span> CacheFirst <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'workbox-strategies'</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span> RangeRequestsPlugin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'workbox-range-requests'</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span> TrackFileProgressPlugin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./lib/track-file-progress-plugin'</span><span class="token punctuation">;</span> <span class="token comment">// to-do</span><br><br><span class="token function">registerRoute</span><span class="token punctuation">(</span><br>  <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> request <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token comment">// Match all relevant audio files here...</span><br>    <span class="token keyword">return</span> request<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'https://your-domain.com/audio/'</span><span class="token punctuation">)</span> <br>      <span class="token operator">&amp;&amp;</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.(mp3|m4a|wav)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token keyword">new</span> <span class="token class-name">CacheFirst</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>    <span class="token literal-property property">cacheName</span><span class="token operator">:</span> <span class="token string">'audio-files'</span><span class="token punctuation">,</span><br>    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>      <span class="token comment">// We must store full files in ServiceWorker cache, but this plugin allows</span><br>      <span class="token comment">// requests with range: header (e.g. from &lt;audio> or &lt;video> elements) to</span><br>      <span class="token comment">// be served only a portion of the cached file instead of the whole thing</span><br>      <span class="token keyword">new</span> <span class="token class-name">RangeRequestsPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <br>      <span class="token comment">// Our custom plugin!</span><br>      <span class="token keyword">new</span> <span class="token class-name">TrackFileProgressPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// Pre-cache other files *after* defining the above</span></code></pre>
<p>Then define a <code>TrackFileProgressPlugin</code> that tracks download progress as it saves the file.</p>
<p><em>Note: the following file is written in TypeScript. To convert it to plain JavaScript you can just paste it in on this website: <a href="https://www.typescriptlang.org/play">www.typescriptlang.org/play</a></em></p>
<pre class="language-ts"><code class="language-ts"><span class="token comment">// track-file-progress-plugin.ts</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span> WorkboxPlugin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'workbox-core'</span><span class="token punctuation">;</span><br><br><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">TrackFileProgressPlugin</span> <span class="token keyword">implements</span> <span class="token class-name">WorkboxPlugin</span> <span class="token punctuation">{</span><br>  broadcast<span class="token operator">:</span> BroadcastChannel<span class="token punctuation">;</span><br><br>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Setup broadcast channel for communicating download progress</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>broadcast <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BroadcastChannel</span><span class="token punctuation">(</span><span class="token string">'audio-downloads'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token comment">/**<br>   * Called before a Response is used to update a cache<br>   * @return {Response|null} - Return null to avoid caching<br>   */</span><br>  cacheWillUpdate<span class="token operator">:</span> WorkboxPlugin<span class="token punctuation">[</span><span class="token string">'cacheWillUpdate'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span><br>    response<span class="token punctuation">,</span><br>    request<span class="token punctuation">,</span><br>    state<span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">shouldCacheResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Helper function for sending progress to client</span><br>    <span class="token comment">// Added to state object so cacheDidUpdate method can access it</span><br>    state<span class="token punctuation">.</span><span class="token function-variable function">reportProgress</span> <span class="token operator">=</span> <span class="token punctuation">(</span>progressPercent<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>      <span class="token keyword">this</span><span class="token punctuation">.</span>broadcast<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>        type<span class="token operator">:</span> <span class="token string">'DOWNLOAD_PROGRESS'</span><span class="token punctuation">,</span><br>        url<span class="token operator">:</span> request<span class="token punctuation">.</span>url<span class="token punctuation">,</span><br>        progress<span class="token operator">:</span> progressPercent<span class="token punctuation">,</span><br>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">// Clone response b/c stream can only be used once (either for tracking download</span><br>    <span class="token comment">// or for saving to cache, not both)</span><br>    <span class="token keyword">const</span> clonedResponse <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token function">trackDownloadProgress</span><span class="token punctuation">(</span>clonedResponse<span class="token punctuation">,</span> state<span class="token punctuation">.</span>reportProgress<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Convert response from 206 -> 200 to make it cacheable</span><br>    <span class="token comment">// ONLY do this if 206 response actually contains entire file</span><br>    <span class="token keyword">return</span> response<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><br>      <span class="token operator">?</span> response<br>      <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>body<span class="token punctuation">,</span> <span class="token punctuation">{</span> status<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span> headers<span class="token operator">:</span> response<span class="token punctuation">.</span>headers <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>  <span class="token comment">/**<br>   * Called after Response is successfully saved to cache<br>   */</span><br>  cacheDidUpdate<span class="token operator">:</span> WorkboxPlugin<span class="token punctuation">[</span><span class="token string">'cacheDidUpdate'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> state <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token comment">// Optional: guarantee that file is marked as fully downloaded in the event</span><br>    <span class="token comment">// that progress tracking fails</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>reportProgress<span class="token punctuation">)</span> state<span class="token punctuation">.</span><span class="token function">reportProgress</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// Helper function for tracking download progress</span><br><span class="token comment">// Adapted from: https://github.com/AnthumChris/fetch-progress-indicators/blob/master/sw-basic/sw-simple.js#L41</span><br><span class="token keyword">function</span> <span class="token function">trackDownloadProgress</span><span class="token punctuation">(</span>response<span class="token operator">:</span> Response<span class="token punctuation">,</span> reportProgress<span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// Start tracking</span><br>  <span class="token function">reportProgress</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">let</span> totalBytes<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span><br>  <span class="token keyword">try</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Ensure that the browser supports ReadableStream and we know total file size</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>response<span class="token punctuation">.</span>body<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token string">'response.body missing'</span><span class="token punctuation">;</span><br>    totalBytes <span class="token operator">=</span> <span class="token function">getFileSize</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Failed to track download progress'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">let</span> loadedBytes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> reader <span class="token operator">=</span> response<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">getReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">new</span> <span class="token class-name">ReadableStream</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>    <span class="token keyword">async</span> <span class="token function">start</span><span class="token punctuation">(</span>controller<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>      <span class="token keyword">function</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        reader<br>          <span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>          <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span> done<span class="token punctuation">,</span> value <span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span> done<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span> value<span class="token operator">:</span> Uint8Array <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>            <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>              controller<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>              <span class="token keyword">return</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span><br><br>            controller<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><br>            loadedBytes <span class="token operator">+=</span> value<span class="token punctuation">.</span>byteLength<span class="token punctuation">;</span><br>            <span class="token function">reportProgress</span><span class="token punctuation">(</span>loaded <span class="token operator">/</span> totalBytes<span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>          <span class="token punctuation">}</span><span class="token punctuation">)</span><br>          <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span>error<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>            <span class="token comment">// Error only typically occurs if network fails mid-download</span><br>            <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'error in read()'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span><br>            controller<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span><br>          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span><br><br>    <span class="token comment">// Firefox excutes this on page stop, Chrome does not</span><br>    <span class="token function">cancel</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'cancel()'</span><span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">/**<br> * Get total file size in bytes<br> */</span><br><span class="token keyword">function</span> <span class="token function">getFileSize</span><span class="token punctuation">(</span>response<span class="token operator">:</span> Response<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// If content is encoded, then content-length will not be accurate</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'content-encoding'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token string">'content-encoding header'</span><span class="token punctuation">;</span><br>  <br>  <span class="token comment">// We use content-length header to get total file size</span><br>  <span class="token keyword">const</span> contentLength <span class="token operator">=</span> response<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'content-length'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>contentLength <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token string">'content-length missing'</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">return</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>contentLength<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">/**<br> * Only cache file if the full file is provided. Don't cache<br> * partial 206 responses  <br> */</span><br><span class="token keyword">function</span> <span class="token function">shouldCacheResponse</span><span class="token punctuation">(</span>response<span class="token operator">:</span> Response<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">206</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">try</span> <span class="token punctuation">{</span><br>      <span class="token comment">// Did 206 response include entire file?</span><br>      <span class="token keyword">const</span> contentLength <span class="token operator">=</span> <span class="token function">getFileSize</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">return</span> <span class="token punctuation">(</span><br>        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">bytes 0-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>contentLength <span class="token operator">-</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>contentLength<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">===</span><br>        response<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'content-range'</span><span class="token punctuation">)</span><br>      <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>The only remaining item is to setup and listen to the broadcast channel on your page:</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// app.js</span><br><span class="token keyword">const</span> broadcast <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BroadcastChannel</span><span class="token punctuation">(</span><span class="token string">'audio-downloads'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>broadcast<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>data <span class="token operator">&amp;&amp;</span> event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'DOWNLOAD_PROGRESS'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> <span class="token punctuation">{</span> url<span class="token punctuation">,</span> progress <span class="token punctuation">}</span> <span class="token operator">=</span> event<span class="token punctuation">.</span>data<span class="token punctuation">;</span><br>    <span class="token comment">// Handle progress...</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br></code></pre>
<p><code>BroadcastChannel</code> is a super simple API, but is <a href="https://caniuse.com/broadcastchannel">only supported by Safari 15.4+</a>, so you may want to use a different way of communicating with the client to support older browsers. There's actually <a href="https://felixgerschau.com/how-to-communicate-with-service-workers/">quite a few options</a>.</p>
<p>Also, if you're explicitly downloading files with <code>fetch()</code> requests instead of <code>&lt;audio&gt;</code> or <code>&lt;video&gt;</code> elements, then you can omit the <code>RangeRequestsPlugin</code> and my <a href="https://github.com/GoogleChrome/workbox/issues/1644#issuecomment-1126871851">conditions for 206 responses</a>.</p>
<p>And if you run into any snags or have suggestions for improvement, don't hesitate to leave a comment! I simplied some of this code for this post, so apologies in advance if there are any typos.</p>
</section>
  <footer class="post__footer">
    <img class="post__footer-avatar" src="/assets/images/profile-circle-240-tiny.png" />
    <p class="post__footer-author">Micah Engle-Eshleman</p>
    <section class="share">
  <a class="share__button share__button--twitter" href="https://twitter.com/intent/tweet?text=/2022/track-download-progress-workbox/ -  by @">
    <svg viewBox="0 0 128 128">
      <path d="M128 28.3c-4.7 2.1-9.775 3.5-15.075 4.125 5.425-3.25 9.575-8.4 11.55-14.525-5.075 3-10.7 5.2-16.675 6.375-4.8-5.1-11.625-8.275-19.175-8.275-14.5 0-26.25 11.75-26.25 26.25 0 2.050 0.225 4.050 0.675 5.975-21.825-1.1-41.175-11.55-54.125-27.45-2.25 3.875-3.55 8.4-3.55 13.2 0 9.1 4.625 17.15 11.675 21.85-4.3-0.125-8.35-1.325-11.9-3.275 0 0.1 0 0.225 0 0.325 0 12.725 9.050 23.35 21.075 25.75-2.2 0.6-4.525 0.925-6.925 0.925-1.7 0-3.325-0.175-4.95-0.475 3.35 10.425 13.050 18.025 24.525 18.25-9 7.050-20.3 11.25-32.625 11.25-2.125 0-4.2-0.125-6.275-0.375 11.65 7.475 25.45 11.8 40.275 11.8 48.3 0 74.725-40.025 74.725-74.725 0-1.15-0.025-2.275-0.075-3.4 5.125-3.675 9.575-8.3 13.1-13.575z"></path>
    </svg>
    Tweet
  </a>
  <a class="share__button share__button--facebook" href="#" onclick="
      window.open(
        'https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent(location.href),
        'facebook-share-dialog',
        'width=626,height=436');
      return false;">
    <svg viewBox="0 0 128 128">
      <path d="M76 24h20v-24h-20c-15.439 0-28 12.561-28 28v12h-16v24h16v64h24v-64h20l4-24h-24v-12c0-2.168 1.832-4 4-4z"></path>
    </svg>
    Facebook
  </a>
</section>
  </footer>
</article>

<div class="comments">
	<h3 class="comments__heading">Comments are welcome!</h3>
	<div id="disqus_thread"></div>
	<script>
	var disqus_config = function () {
		// Page url without query parameters or hashes
		this.page.url = window.location.href.split('?')[0].split('#')[0];
		// Id is just slug of post
		this.page.identifier = '';
	};
	(function() { // DON'T EDIT BELOW THIS LINE
		var d = document, s = d.createElement('script');
		s.src = '//micahjon.disqus.com/embed.js';
		s.setAttribute('data-timestamp', +new Date());
		(d.head || d.body).appendChild(s);
	})();
	</script>
	<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

    </main>

    <footer class="site-footer">
    <p>¬© Copyright <span id="currentYear"></span> Micah Engle-Eshleman</p>
    <script>document.getElementById('currentYear').textContent = new Date().getFullYear()</script>
    
</footer>


    <script async src="/assets/js/main.js?v=1"></script>
    <link href="/assets/css/prism-material-oceanic.css" rel="stylesheet">

  <style>
    
  </style>


  </body>
</html>
