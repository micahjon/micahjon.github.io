<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>
      Conditional Logic with Zod + React Hook Form (work in progress...) | Micah Engle-Eshleman
    </title>
    <link rel="shortcut icon" href="/assets/images/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/style.css?v=1" />
    

    
    <script defer data-api="https://ana.adblockpodcast.com/api/event" data-domain="micahjon.com" src="/assets/js/plsible.js"></script>
  </head>

  <body>
    <nav class="top-nav">
	
		<a href="/"> <span class="arrow">‚Üê</span> Home </a>
	

	
		<a href="/about">About Me </a>
	

	<a aria-label="Github" href="https://github.com/micahjon" target="_blank" style="padding: 0.5rem">
		<svg style="vertical-align: middle; margin-top: -4px;" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
			<path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
		</svg>
	</a>

	<a aria-label="RSS Feed" href="/feed.xml" style="padding: 0.5rem">
		<svg style="vertical-align: middle; margin-top: -4px;" xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 24.9 24.9" xml:space="preserve">
			<path d="M3.7 17.5a3.7 3.7 0 1 0 0 7.4 3.7 3.7 0 0 0 0-7.4z"/>
			<path d="M.4 8.1c-.2 0-.4.2-.4.4v4.7c0 .2.2.4.4.4 6 0 10.9 4.9 10.9 11 0 .1.2.3.4.3h4.7c.2 0 .4-.2.4-.4v-.1C16.7 15.4 9.4 8.1.4 8.1z"/>
			<path d="M24.9 24.4C24.9 10.9 13.9 0 .4 0 .2 0 0 .2 0 .4v4.8c0 .2.2.4.4.4a19 19 0 0 1 18.9 19c0 .1.2.3.4.3h4.8c.2 0 .4-.2.4-.4v-.1z"/>
		</svg>
	</a>
</nav> 
    

    <main class="centered-column post-container">
      
<article class="post">
  <header class="post__header">
    <h1 class="post__title">Conditional Logic with Zod + React Hook Form (work in progress...)</h1>
    <p class="post__date">October 14, 2023</p>  
  </header>
  <section class="post__body"><p><em>This post is a work-in-progress.</em></p>
<p>When I started at Redwood last year, it became clear that a big part of my job would involve building long and complex forms. Like most software, the easiest to use forms often mask a lot of complexity under the hood, and I knew from experience that schemas and type safety would be my friends. After some research I settled on:</p>
<ul>
<li>React Hook Form for managing form state changes w/ minimal re-renders</li>
<li>Zod for writing form schemas and doing validation</li>
</ul>
<p>Almost a year later, with quite a few forms in production, I'm still happy with this pairing. BUT, there were definitely some major gotchas along the way, which is why I'm writing this post.</p>
<h2>A super simple form</h2>
<p>Let's start with just a single email field. We use Zod to validate the email address and also generate a <code>FormSchema</code> type that React Hook Form uses to infer the field names &amp; values.</p>
<p><img src="/assets/images/rhf-email-field.png" alt="Email field"></p>
<pre class="language-tsx"><code class="language-tsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> useForm <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react-hook-form"</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span> z <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"zod"</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span> zodResolver <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@hookform/resolvers/zod"</span><span class="token punctuation">;</span><br><br><span class="token comment">// Setup Zod schema</span><br><span class="token keyword">const</span> formSchema <span class="token operator">=</span> z<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  email<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">email</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">type</span> <span class="token class-name">FormSchema</span> <span class="token operator">=</span> z<span class="token punctuation">.</span>infer<span class="token operator">&lt;</span><span class="token keyword">typeof</span> formSchema<span class="token operator">></span><span class="token punctuation">;</span><br><br><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">Form</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// Setup React Hook Form validated by Zod</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span><br>    register<span class="token punctuation">,</span><br>    handleSubmit<span class="token punctuation">,</span><br>    formState<span class="token operator">:</span> <span class="token punctuation">{</span> errors <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token generic-function"><span class="token function">useForm</span><span class="token generic class-name"><span class="token operator">&lt;</span>FormSchema<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>    resolver<span class="token operator">:</span> <span class="token function">zodResolver</span><span class="token punctuation">(</span>formSchema<span class="token punctuation">)</span><span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// data is guaranteed to match FormSchema </span><br>  <span class="token keyword">const</span> <span class="token function-variable function">onSubmitSuccess</span> <span class="token operator">=</span> <span class="token punctuation">(</span>data<span class="token operator">:</span> FormSchema<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Valid submission:"</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">onSubmit</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">handleSubmit</span><span class="token punctuation">(</span>onSubmitSuccess<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text"><br>      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">></span></span><span class="token plain-text"><br>        Email<br>        </span><span class="token punctuation">{</span><span class="token comment">/* If we were to mis-type "email", we'd get a Typescript error, yay! */</span><span class="token punctuation">}</span><span class="token plain-text"><br>        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>email<span class="token punctuation">"</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token operator">...</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">"email"</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text"><br>        </span><span class="token punctuation">{</span>errors<span class="token punctuation">.</span>email <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>errors<span class="token punctuation">.</span>email<span class="token punctuation">.</span>message<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span class="token punctuation">}</span><span class="token plain-text"><br>      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span><span class="token plain-text"><br>      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">Submit</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text"><br>    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p><em>This example is a bit contrived, as we could accomplish all of this with plain HTML:</em></p>
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>email<span class="token punctuation">"</span></span> <span class="token attr-name">required</span> <span class="token punctuation">/></span></span></code></pre>
</aside>
<p>But the benefit of Zod is that it allows you to apply custom validation to any field type and you're guaranteed to end up with the schema you expect upon submission (or an intelligible error message).</p>
<h2>The importance of default values</h2>
<p>There is one bug in our simple form above, and it's due to missing default values. According to <code>FormSchema</code>, <code>email</code> must always be a string, so we'd expect it to start out as an empty string. But React Hook Form does not assign default values, so email starts off as <code>undefined</code>. As expected, when watching the value, we get <code>undefined</code> (matching React Hook Form's internal state), but the <code>getValues()</code> function will return an empty string if called <em>after</em> the email input has been rendered, presumably b/c it actually checks the email input's <code>.value</code> property.</p>
<pre class="language-tsx"><code class="language-tsx"><span class="token keyword">const</span> <span class="token punctuation">{</span><br>  register<span class="token punctuation">,</span><br>  handleSubmit<span class="token punctuation">,</span><br>  control<span class="token punctuation">,</span><br>  getValues<span class="token punctuation">,</span><br>  formState<span class="token operator">:</span> <span class="token punctuation">{</span> errors <span class="token punctuation">}</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token generic-function"><span class="token function">useForm</span><span class="token generic class-name"><span class="token operator">&lt;</span>FormSchema<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  resolver<span class="token operator">:</span> <span class="token function">zodResolver</span><span class="token punctuation">(</span>formSchema<span class="token punctuation">)</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// useWatch() gets the form's values as tracked in JavaScript</span><br><span class="token keyword">const</span> watchedEmail <span class="token operator">=</span> <span class="token function">useWatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> control<span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">"email"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Watched email:"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> email<span class="token operator">:</span> watchedEmail <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// getValues() gets the form's values from the DOM</span><br><span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Email field value:"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> email<span class="token operator">:</span> <span class="token function">getValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>email <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// Force re-rendering after email field has been rendered</span><br><span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> forceUpdate<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useReducer</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">=></span> x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Force re-rendering..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">forceUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><img src="/assets/images/rhf-email-console.png" alt="Email-related console output"></p>
<p>This may not sound like a big deal, but can really bite you if you have any logic based on email, as it would break during the forms first render despite Typescript being positive that it's a string!</p>
<p><img src="/assets/images/rhf-watchEmail.png" alt="watchedEmail type is string">
<img src="/assets/images/rhf-getValuesemail.png" alt="getValues().email type is string"></p>
<p>The solution is simple: provide default values (like the <a href="https://www.react-hook-form.com/api/useform/#defaultValues">React Hook Form docs recommend</a>)</p>
<pre class="language-tsx"><code class="language-tsx"><span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token generic-function"><span class="token function">useForm</span><span class="token generic class-name"><span class="token operator">&lt;</span>FormSchema<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  resolver<span class="token operator">:</span> <span class="token function">zodResolver</span><span class="token punctuation">(</span>formSchema<span class="token punctuation">)</span><span class="token punctuation">,</span><br>  defaultValues<span class="token operator">:</span> <span class="token punctuation">{</span> email<span class="token operator">:</span> <span class="token string">""</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// &lt;-- Default value</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><em>Note: if using <code>reset()</code> to clear the form, be sure to pass default values so the form is actually reset to it's initial values as you'd expect.</em></p>
<h2>Fields with more complex types</h2>
<p>Sometimes it's nice to be able to store a value in a form that isn't a simple string, number, or other primitive type.</p>
<p>For instance, let's say we want the user to select a color from a list of options in dropdown list, where each option has a label and a value.</p>
<pre class="language-tsx"><code class="language-tsx"><span class="token keyword">type</span> <span class="token class-name">Option</span> <span class="token operator">=</span> <span class="token punctuation">{</span> label<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">}</span><br><span class="token keyword">const</span> colorOptions<span class="token operator">:</span> Option<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><br>  <span class="token punctuation">{</span> label<span class="token operator">:</span> <span class="token string">'Red'</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token string">'#E83845'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span> label<span class="token operator">:</span> <span class="token string">'Brown'</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token string">'#9B634C'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span> label<span class="token operator">:</span> <span class="token string">'Tan'</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token string">'F2DFB4'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br><span class="token punctuation">]</span></code></pre>
<p>Representing this in Zod schema is trivial:</p>
<pre class="language-tsx"><code class="language-tsx"><span class="token keyword">const</span> optionSchema <span class="token operator">=</span> z<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  name<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  label<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> formSchema <span class="token operator">=</span> z<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  email<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">email</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  color<span class="token operator">:</span> optionSchema<span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">type</span> <span class="token class-name">FormSchema</span> <span class="token operator">=</span> z<span class="token punctuation">.</span>infer<span class="token operator">&lt;</span><span class="token keyword">typeof</span> formSchema<span class="token operator">></span><span class="token punctuation">;</span></code></pre>
<p>But what should our default value for this field be? I would reach for <code>null</code> in this case, since it clearly indicates that it's an empty value.</p>
<pre class="language-tsx"><code class="language-tsx"><span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token generic-function"><span class="token function">useForm</span><span class="token generic class-name"><span class="token operator">&lt;</span>FormSchema<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  resolver<span class="token operator">:</span> <span class="token function">zodResolver</span><span class="token punctuation">(</span>formSchema<span class="token punctuation">)</span><span class="token punctuation">,</span><br>  defaultValues<span class="token operator">:</span> <span class="token punctuation">{</span> email<span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span> color<span class="token operator">:</span> <span class="token keyword">null</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// &lt;-- Default values</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Hmm, <code>null</code> doesn't satisfy <code>FormSchema</code>:</p>
<p><img src="/assets/images/rhf-color-null.png" alt="null color fails type check"></p>
<p>Of course you could use a different initial value that does satisfy FormSchema, e.g. <code>{value: '', label: ''}</code>, but at the end of the day your initial values shouldn't be constrained by your final values. I eventually threw up my hands, took a deep breath, and made peace with defining two schemas:</p>
<ul>
<li><code>formSchema</code> represents a valid (complete) form submission</li>
<li><code>blankFormSchema</code> represents the form's default (blank) values</li>
</ul>
<pre class="language-ts"><code class="language-ts"><span class="token comment">// Valid form submission</span><br><span class="token keyword">export</span> <span class="token keyword">const</span> formSchema <span class="token operator">=</span> z<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  email<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">email</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  color<span class="token operator">:</span> optionSchema<span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">FormSchema</span> <span class="token operator">=</span> z<span class="token punctuation">.</span>infer<span class="token operator">&lt;</span><span class="token keyword">typeof</span> formSchema<span class="token operator">></span><span class="token punctuation">;</span><br><br><span class="token comment">// Blank form values</span><br><span class="token keyword">const</span> blankFormSchema <span class="token operator">=</span> formSchema<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span> color<span class="token operator">:</span> optionSchema<span class="token punctuation">.</span><span class="token function">nullable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">BlankFormSchema</span> <span class="token operator">=</span> z<span class="token punctuation">.</span>infer<span class="token operator">&lt;</span><span class="token keyword">typeof</span> blankFormSchema<span class="token operator">></span><span class="token punctuation">;</span></code></pre>
<p>Whew! That's a lot of boilerplate just for type safety. FWIW, I typically create a separate file with a form's schemas (e.g. <code>my-form-schemas.ts</code>) to avoid cluttering my React component file.</p>
<p>If you sweat the details as much as I do (sigh), you may have noticed that <code>blankFormSchema</code> still expects <code>email</code> to be a valid email, not an empty string. While this is true, since the purpose of this schema is just to generate a more permissive Typescript type, it doesn't  matter. If it bothers you, could you construct that type explicity:</p>
<pre class="language-ts"><code class="language-ts"><span class="token keyword">type</span> <span class="token class-name">Modify<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">,</span> <span class="token constant">R</span><span class="token operator">></span></span> <span class="token operator">=</span> Omit<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">,</span> <span class="token keyword">keyof</span> <span class="token constant">R</span><span class="token operator">></span> <span class="token operator">&amp;</span> <span class="token constant">R</span><span class="token punctuation">;</span><br><span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">BlankFormSchema</span> <span class="token operator">=</span> Modify<span class="token operator">&lt;</span><br>  FormSchema<span class="token punctuation">,</span><br>  <span class="token punctuation">{</span><br>    color<span class="token operator">:</span> FormSchema<span class="token punctuation">[</span><span class="token string">"color"</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token operator">></span><span class="token punctuation">;</span></code></pre>
<p>I typically define default values below my schemas. Verbose, I know. Evidently, it is possible to programmatically generate default values from a Zod schema using a <a href="https://gist.github.com/TonyGravagno/2b744ceb99e415c4b53e8b35b309c29c">hacky workaround like this one</a>, but I am reluctant to adopt it until it's actually documented and supported officially by Zod.</p>
<pre class="language-tsx"><code class="language-tsx"><span class="token keyword">export</span> <span class="token keyword">const</span> defaultValues<span class="token operator">:</span> BlankFormSchema <span class="token operator">=</span> <span class="token punctuation">{</span><br>  email<span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span><br>  color<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token comment">// or if I'm worried about downstream mutation...</span><br><span class="token keyword">export</span> <span class="token keyword">const</span> getDefaultValues <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> BlankFormSchema <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span><br>  email<span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span><br>  color<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Now that we've got two schemas, how do we apply them to the form itself?</p>
<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> <span class="token punctuation">{</span><br>  register<span class="token punctuation">,</span><br>  handleSubmit<span class="token punctuation">,</span><br>  formState<span class="token operator">:</span> <span class="token punctuation">{</span> errors <span class="token punctuation">}</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token generic-function"><span class="token function">useForm</span><span class="token generic class-name"><span class="token operator">&lt;</span>BlankFormSchema<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token comment">// BlankFormSchema encompasses all possible field values</span><br>  resolver<span class="token operator">:</span> <span class="token function">zodResolver</span><span class="token punctuation">(</span>formSchema<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// formSchema is used for validation</span><br>  defaultValues<span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> <span class="token function-variable function">onSubmitSuccess</span> <span class="token operator">=</span> <span class="token punctuation">(</span>data<span class="token operator">:</span> BlankFormSchema<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token comment">// We know that upon submission, data satisfies FormSchema</span><br>  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Valid submission:"</span><span class="token punctuation">,</span> data <span class="token keyword">as</span> FormSchema<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>I'm not thrilled with this solution, but it gets the job done. Within our component, Typescript uses <code>BlankFormSchema</code> so that we are sure to handle <em>all possible</em> field values, but upon submission we are certain that the resulting data matches <code>FormSchema</code>.</p>
<h2>Conditional Logic</h2>
<p>I wish there was an easy solution to this.</p>
<p>At its core, conditional logic means using the values in some fields to determine whether to show or hide other fields that depend on them. If we think of our typical form as a list of fields (or a tree with no branches), conditional logic introduces branches: multiple paths a user can take through our form.</p>
<pre><code>             [name]
                |
             [email]
                |
(condition: is this email domain in our database?)
        / yes           \ no
      (submit)      [company name]
                           |
                   [company location]
                       (submit)
</code></pre>
<p>To represent this accurately in Zod &amp; Typescript, we'd need to extend the base schema <em>for every conditional logic branch in our form</em>. Will this scale to large forms? Probably not. But let's at least go through the exercise of seeing what it would entail for the above example:</p>
<pre class="language-tsx"><code class="language-tsx"><span class="token keyword">const</span> formSchemaLeft <span class="token operator">=</span> z<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  name<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  email<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">email</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> formSchemaRight <span class="token operator">=</span> formSchemaLeft<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  companyName<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  companyLocation<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> formSchema <span class="token operator">=</span> z<span class="token punctuation">.</span><span class="token function">union</span><span class="token punctuation">(</span><span class="token punctuation">[</span>formSchemaLeft<span class="token punctuation">,</span> formSchemaRight<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">type</span> <span class="token class-name">FormSchema</span> <span class="token operator">=</span> z<span class="token punctuation">.</span>infer<span class="token operator">&lt;</span><span class="token keyword">typeof</span> formSchema<span class="token operator">></span><span class="token punctuation">;</span></code></pre>
<p>...which gives us a beautiful union type:</p>
<p><img src="/assets/images/rhf-formschema-union.png" alt="FormSchema type"></p>
<p>Let's imagine a user fills out this form on the right branch but fails to enter a company location before submitting. React Hook Form passes the following object to Zod for validation:</p>
<pre class="language-ts"><code class="language-ts">formSchema<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  name<span class="token operator">:</span> <span class="token string">"Micah"</span><span class="token punctuation">,</span><br>  email<span class="token operator">:</span> <span class="token string">"micah@my-company.com"</span><span class="token punctuation">,</span><br>  companyName<span class="token operator">:</span> <span class="token string">"My Company"</span><span class="token punctuation">,</span><br>  companyLocation<span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span> <br><span class="token comment">// Result = {name: 'Micah', email: 'micah@my-company.com'}</span><br><span class="token comment">// What? Company location is blank!</span></code></pre>
<p>For union schemas, Zod will return the first schema that passes (left branch). It does not know that we only really care about the right branch in this scenario. We could try and make these schemas <code>.strict()</code> (not accepting additional properties), in which case the left branch would also fail validation, but in the case of both branches failing (left due to extra properties, right due to missing company name), Zod only exposes the error for the first failing schema in the union.</p>
<p>The solution is to conditionally pass React Hook Form the schema that matches our current branch. Here's how that might look...</p>
<pre class="language-tsx"><code class="language-tsx"><span class="token keyword">const</span> <span class="token punctuation">{</span><br>  register<span class="token punctuation">,</span><br>  handleSubmit<span class="token punctuation">,</span><br>  formState<span class="token operator">:</span> <span class="token punctuation">{</span> errors <span class="token punctuation">}</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token generic-function"><span class="token function">useForm</span><span class="token generic class-name"><span class="token operator">&lt;</span>BlankFormSchema<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  <span class="token function-variable function">resolver</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>values<span class="token operator">:</span> BlankFormSchema<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Choose correct schema for current branch</span><br>    <span class="token keyword">const</span> currentBranchSchema <span class="token operator">=</span> <span class="token function">isKnownDomain</span><span class="token punctuation">(</span>values<span class="token punctuation">.</span>email<span class="token punctuation">)</span><br>      <span class="token operator">?</span> formSchemaLeft<br>      <span class="token operator">:</span> formSchemaRight<span class="token punctuation">;</span><br>    <span class="token keyword">return</span> <span class="token function">zodResolver</span><span class="token punctuation">(</span>currentBranchSchema<span class="token punctuation">)</span><span class="token punctuation">(</span>values<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  defaultValues<span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Wow, that actually works. We still have a couple problems though:</p>
<ol>
<li>
<p>At a high level, do we really want to have to define a new schema for every conditional logic branch?</p>
</li>
<li>
<p>Our conditional logic now lives in 3 different places: implicity in our choice to create a new schema, explicitly in the React Hook Forms resolver function (above), and explicity in our Form component JSX. Gross!</p>
</li>
</ol>
<p>Ideally we'd have a way of declaratively defining both the conditional logic condition, the fields it depended on, and the fields it impacted, and could then programmatically generate the associated schemas and know what fields needed to be shown / hidden.</p>
<p><em>This post is a work-in-progress, as I'm still iterating toward and ideal solution. Currently, I just set all branching fields as <code>.optional()</code> in my Zod schema, and create a re-usable function that accepts my form schema and returns the fields names that need to be toggled, whether each one is visible, and also the field names that need to be watched to determine this (depedency array). This works fine and allows me to use some of the same logic in my React components as the <code>resolver</code> method, but I feel like there's probably a better way.</em></p>
</section>
  <footer class="post__footer">
    <img class="post__footer-avatar" src="/assets/images/profile-circle-240-tiny.png" />
    <p class="post__footer-author">Micah Engle-Eshleman</p>
    <section class="share">
  <a class="share__button share__button--twitter" href="https://twitter.com/intent/tweet?text=Conditional%20Logic%20with%20Zod%20%2B%20React%20Hook%20Form%20(work%20in%20progress...)&url=micahjon.com%2F2023%2Fform-validation-with-zod%2F&via=micahjon">
    <svg viewBox="0 0 128 128">
      <path d="M128 28.3c-4.7 2.1-9.775 3.5-15.075 4.125 5.425-3.25 9.575-8.4 11.55-14.525-5.075 3-10.7 5.2-16.675 6.375-4.8-5.1-11.625-8.275-19.175-8.275-14.5 0-26.25 11.75-26.25 26.25 0 2.050 0.225 4.050 0.675 5.975-21.825-1.1-41.175-11.55-54.125-27.45-2.25 3.875-3.55 8.4-3.55 13.2 0 9.1 4.625 17.15 11.675 21.85-4.3-0.125-8.35-1.325-11.9-3.275 0 0.1 0 0.225 0 0.325 0 12.725 9.050 23.35 21.075 25.75-2.2 0.6-4.525 0.925-6.925 0.925-1.7 0-3.325-0.175-4.95-0.475 3.35 10.425 13.050 18.025 24.525 18.25-9 7.050-20.3 11.25-32.625 11.25-2.125 0-4.2-0.125-6.275-0.375 11.65 7.475 25.45 11.8 40.275 11.8 48.3 0 74.725-40.025 74.725-74.725 0-1.15-0.025-2.275-0.075-3.4 5.125-3.675 9.575-8.3 13.1-13.575z"></path>
    </svg>
    Tweet
  </a>
  <a class="share__button share__button--facebook" href="#" onclick="
      window.open(
        'https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent(location.href),
        'facebook-share-dialog',
        'width=626,height=436');
      return false;">
    <svg viewBox="0 0 128 128">
      <path d="M76 24h20v-24h-20c-15.439 0-28 12.561-28 28v12h-16v24h16v64h24v-64h20l4-24h-24v-12c0-2.168 1.832-4 4-4z"></path>
    </svg>
    Facebook
  </a>
</section>
  </footer>
  <div class="post__footer" style="border-top: 0; padding-top: 0; margin-top: 0; flex-wrap: nowrap">
    <img src="https://www.adblockpodcast.com/assets/icons/no-precache/logo-square-192.png" alt="Adblock Podcast logo" width="80px" style="border-radius: 50%; margin: 0 1rem 1rem 0; max-width: 38.1%;" />
    <p>While you're here, check out my latest project: <a href="https://www.adblockpodcast.com/?utm_source=micahjon.com&utm_medium=referral">a podcast app that skips ads!</a></p>
  </div>
</article>

<div class="comments">
	<h3 class="comments__heading">Comments are welcome!</h3>
	<div id="disqus_thread"></div>
	<script>
	var disqus_config = function () {
		// Page url without query parameters or hashes
		this.page.url = window.location.href.split('?')[0].split('#')[0];
		// Id is just slug of post
		this.page.identifier = '';
	};
	(function() { // DON'T EDIT BELOW THIS LINE
		var d = document, s = d.createElement('script');
		s.src = '//micahjon.disqus.com/embed.js';
		s.setAttribute('data-timestamp', +new Date());
		(d.head || d.body).appendChild(s);
	})();
	</script>
	<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

    </main>

    <footer class="site-footer">
    <p>¬© Copyright <span id="currentYear"></span> Micah Engle-Eshleman</p>
    <script>document.getElementById('currentYear').textContent = new Date().getFullYear()</script>
</footer>


    <script async src="/assets/js/main.js?v=1"></script>
    <link href="/assets/css/prism-material-oceanic.css" rel="stylesheet">

  <style>
    
  </style>


  </body>
</html>
